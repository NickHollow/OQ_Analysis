
-- OQ_NodeIdFromGeom Search id in Nodes table that corresponds to point geometry

SELECT *, public.OQ_NodeIdFromGeom('oq_sample.nodes', ST_AsText(geom)) 
FROM oq_sample.nodes limit 10;

|id        |version|user_id|tstamp             |changeset_id|tags|geom                          |oq_nodeidfromgeom|
|----------|-------|-------|-------------------|------------|----|------------------------------|-----------------|
|6196765086|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.441037 43.691997)  |       6196765086|
|6204498029|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.437678 43.691074)  |       6204498029|
|6196765314|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.441998 43.692563)  |       6196765314|
|6196764346|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.439706 43.692162)  |       6196764346|
|6196765251|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.441853 43.691841)  |       6196765251|
| 803316716|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.4389605 43.6917405)|        803316716|
|6196791156|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.442338 43.693125)  |       6196791156|
|6204502502|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.440105 43.691357)  |       6204502502|
|6196764419|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.440329 43.692595)  |       6196764419|
|6196760999|      1|      1|2000-01-01 00:00:00|           1|    |POINT (-79.438234 43.692242)  |       6196760999|

select id, public.OQ_Way_has_shared_nodes('oq_sample',
	'oq_s1a_building', id) as shared_nodes
FROM oq_sample.oq_s1a_building
WHERE exist(tags, 'building') or exist(tags, 'building:part') or exist(tags, 'man_made');

id       |shared_nodes|
---------|------------|
 43806951|false       |
265525959|false       |
265527515|false       |
639843855|true        |
639843857|true        |
639843858|true        |
639843859|true        |
639843862|true        |
639843863|true        |
639843864|false       |
639843867|false       |
661894732|true        |
661894733|true        |
661895265|false       |
661895266|false       |
661895285|false       |
661895286|false       |
661895287|false       |
661895288|false       |
661895289|false       |
661895290|false       |
661895291|false       |
661895292|false       |
661895293|false       |
661895294|false       |
661895295|false       |
661895297|false       |
661895298|false       |
661895299|false       |
661895300|true        |
661895301|false       |
661895302|false       |
661895303|false       |
661895304|false       |
661895305|false       |
661895306|false       |
661895307|false       |
661895308|false       |
661895309|false       |
661895310|false       |
661895311|false       |
661895312|false       |
661895313|false       |
661895314|false       |
661895315|false       |
661895319|false       |
661895320|false       |
661895321|false       |
661895322|false       |
661895323|false       |
661895324|false       |
661895329|false       |
661895331|false       |
661895332|false       |
661895334|false       |
661895335|false       |
661895336|false       |
661895337|false       |
661895463|false       |
661895464|false       |
661895465|false       |
661895466|false       |
661895467|false       |
661895468|false       |
661895469|true        |
661895470|false       |
661895471|false       |
661895472|false       |
661895473|true        |
661895474|true        |
661895475|true        |
661895476|false       |
661895477|false       |
661895478|false       |
661895479|false       |
661895480|false       |
661895496|false       |
661895497|false       |
661895502|false       |
661895510|true        |
661895512|true        |
661895513|true        |
661895514|true        |
661895515|false       |
661895516|false       |
661895517|true        |
661895518|true        |
661895519|true        |
661895520|true        |
661895521|true        |
661895522|true        |
661895523|false       |
661895524|true        |
661895525|false       |
661895526|false       |
661895527|false       |
661895528|false       |
661895529|false       |
661895530|false       |
661895531|false       |
661895532|false       |
661895533|false       |
661895534|false       |
661895535|false       |
661895536|false       |
661895548|false       |
661896900|false       |
661896901|false       |
661896902|false       |
661896903|false       |
661896904|false       |
661896905|false       |
661896906|false       |
661896907|false       |
661896908|false       |
661896909|false       |
661896910|false       |
661896911|false       |
661896912|false       |
661896913|false       |
661896914|false       |
661896915|false       |
661896916|false       |
661896917|false       |
661896924|false       |
661896929|false       |
661896935|false       |
661896946|false       |
661896947|false       |
661896948|false       |
661896949|false       |
661896950|false       |
661896951|false       |
661896952|false       |
661896953|false       |
661896954|false       |
661896955|false       |
661896956|false       |
661896957|false       |
661896958|false       |
661896959|false       |
661896960|false       |
661896966|false       |
661896967|false       |
661896968|true        |
661896969|true        |
661897051|false       |
662766642|false       |
662766643|false       |
662766644|false       |
662766645|false       |
662766646|false       |
662766647|false       |
662766684|false       |
662766685|false       |
662766686|false       |
662766687|false       |
662766688|false       |
662766701|true        |
662766702|false       |
662766880|true        |
662766881|true        |
662766882|false       |
662766883|false       |
662766884|false       |
662766885|false       |
662766895|true        |
662766896|true        |
662769058|false       |
662769059|false       |
662769060|false       |
662769067|false       |
662769068|false       |
662769069|false       |
662769070|false       |
662769071|false       |
662769072|false       |
662769073|false       |

drop table IF EXISTS temp_fjson;
create temporary table temp_fjson as 
SELECT public.OQ_PostGIS2Json('oq_sample','oq_s1a_building','linestring') as tjson;
copy (select tjson from temp_fjson) TO 'd:/temp/oq_s1a_building.geojson' encoding 'utf-8'; 


SELECT *, public.OQ_Block_Adjacent_Polygons_id('oq_sample','oq_s1a_building')
FROM  oq_sample.oq_s1a_building LIMIT 10;

id      |version|user_id|tstamp             |changeset_id|tags                                                                                                                                                                                                                                          |nodes                                                                                                                                                                                                                                                          |linestring                                                                                                                                                                                                                                                     |oq_block_adjacent_polygons_id                                                                                                                                                                                                                                  |
--------|-------|-------|-------------------|------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
 5649357|     10|  76077|2016-11-04 15:20:40|    43407999|"name"=>"Bansley Avenue", "lanes"=>"2", "highway"=>"residential", "surface"=>"asphalt"                                                                                                                                                        |{42074884,3005945528,949007458,42074909,4482597179,4482597178,244216951,243888625}                                                                                                                                                                             |LINESTRING (-79.4420326 43.693129, -79.4420865 43.6930509, -79.4422835 43.6927609, -79.4428422 43.6918097, -79.4428656 43.6917773, -79.4428924 43.691756, -79.4429399 43.6917367, -79.4437333 43.6915529)                                                      |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
10252716|     16|   1679|2014-03-15 12:48:44|    21120326|"name"=>"Alameda Avenue", "lanes"=>"1", "oneway"=>"yes", "source"=>"geobase/statscan", "highway"=>"residential", "surface"=>"asphalt", "maxspeed"=>"30"                                                                                       |{2711909651,949007441,2719431271}                                                                                                                                                                                                                              |LINESTRING (-79.4380907 43.6925981, -79.4375913 43.6913202, -79.4374748 43.6910235)                                                                                                                                                                            |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
66246064|      1|   1679|2010-07-06 03:59:57|     5148080|"source"=>"CanVec 6.0 - NRCan", "addr:interpolation"=>"odd"                                                                                                                                                                                   |{803313207,803318329}                                                                                                                                                                                                                                          |LINESTRING (-79.4440656 43.692672, -79.4440979 43.6927637)                                                                                                                                                                                                     |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
10252800|     11|  40964|2018-09-03 14:26:56|    62255931|"hgv"=>"no", "name"=>"Glenora Avenue", "lanes"=>"2", "highway"=>"residential", "surface"=>"asphalt"                                                                                                                                           |{85167620,2711768691,247128989,2711910045,2711910047,949007459,85169389}                                                                                                                                                                                       |LINESTRING (-79.4388474 43.6915136, -79.4387567 43.691566, -79.4387412 43.6916059, -79.4387612 43.6917193, -79.4388278 43.6918576, -79.4390342 43.6923043, -79.4393411 43.693109)                                                                              |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
22735758|     20|2316730|2019-02-10 00:37:38|    67064006|"name"=>"Vaughan Road", "lanes"=>"2", "highway"=>"tertiary", "surface"=>"asphalt", "maxspeed"=>"40"                                                                                                                                           |{49573646,2711766883,6269087401,6269087399,6269087400,250040029}                                                                                                                                                                                               |LINESTRING (-79.4408253 43.6926125, -79.4406397 43.6925175, -79.4406237 43.6925088, -79.4406078 43.6925002, -79.4405913 43.692491, -79.4402887 43.6923161)                                                                                                     |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
22735816|      8|   1679|2014-03-10 22:26:02|    21037890|"name"=>"Eleanor Avenue", "lanes"=>"2", "highway"=>"residential", "surface"=>"asphalt"                                                                                                                                                        |{243888722,949007431,2711906142,243888723}                                                                                                                                                                                                                     |LINESTRING (-79.441926 43.6919227, -79.4411474 43.6921025, -79.4407462 43.6921879, -79.4406383 43.6922076)                                                                                                                                                     |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
22735821|      8|5633991|2018-10-28 13:47:18|    63956413|"name"=>"Ashbury Avenue", "lanes"=>"1", "oneway"=>"yes", "source"=>"Geobase_Import_2009", "highway"=>"residential", "surface"=>"asphalt", "attribution"=>"GeoBase®", "statscan:rbuid"=>"484989", "geobase:acquisitionTechnique"=>"Vector Data"|{243888733,243888757}                                                                                                                                                                                                                                          |LINESTRING (-79.439917 43.6905711, -79.4430387 43.6898601)                                                                                                                                                                                                     |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
23146015|     11|  76077|2016-11-01 08:56:03|    43325295|"name"=>"Oakwood Avenue", "lanes"=>"1", "oneway"=>"yes", "source"=>"GeoBase NRN", "highway"=>"residential", "surface"=>"asphalt", "attribution"=>"GeoBase®"                                                                                   |{243888723,2711766328,4475029985,250040029}                                                                                                                                                                                                                    |LINESTRING (-79.4406383 43.6922076, -79.4404521 43.6922844, -79.4403775 43.6922989, -79.4402887 43.6923161)                                                                                                                                                    |{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
43806951|      3|9266764|2019-01-09 18:44:08|    66178384|"source"=>"CanVec_Import_2009", "amenity"=>"school", "building"=>"school", "attribution"=>"Natural Resources Canada", "canvec:CODE"=>"2010422", "canvec:UUID"=>"17475319dcea48d783a782be6a484c05"                                             |{555341665,4482597440,4482597441,4482597439,4482597438,4482597436,4482597437,4482597435,4482597433,4482597431,4482597432,4482597430,4482597429,555341663,4482597418,4482597420,4482597417,4482597416,4482597410,4482597411,4482597408,4482597407,4482597406,448|LINESTRING (-79.443181 43.69289, -79.443131 43.692874, -79.443122 43.692888, -79.442973 43.692839, -79.442981 43.692825, -79.442923 43.692806, -79.442914 43.69282, -79.442766 43.692772, -79.442775 43.692757, -79.442723 43.69274, -79.442715 43.692752, -79.|{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|
43886052|      3|   1679|2014-03-15 12:48:45|    21120326|                                                                                                                                                                                                                                              |{557762666,557762664,557762662,2719431265,2719431266,2719431268,2719431270,557762648,557762646,557762644,557762642,557762640,557762660,557762652,557762650,557762666}                                                                                          |LINESTRING (-79.4364778 43.6913781, -79.4360923 43.6904088, -79.4362049 43.6903159, -79.4362335 43.6903307, -79.4363683 43.6904005, -79.4368177 43.6906334, -79.4371917 43.6908245, -79.4372085 43.6908331, -79.4372382 43.6909193, -79.4371476 43.6909375, -79|{639843855,639843857,639843858,639843859,639843862,639843863,661894732,661894733,661895300,661895469,661895473,661895474,661895475,661895510,661895512,661895513,661895514,661895517,661895518,661895519,661895520,661895521,661895522,661895524,661896968,6618|


DROP TABLE IF EXISTS oq_sample.oq_s1b_building_extring;
CREATE TABLE oq_sample.oq_s1b_building_extring
(
    grp_poly integer,
	nodes bigint[],
	ways_id bigint[],
    geom_extring geometry(linestring, 4326)
);

INSERT INTO oq_sample.oq_s1b_building_extring
select (public.OQ_Block_Adjacent_Polygons('oq_sample','oq_s1a_building')).*;

SELECT *, ST_AsText(geom_extring,7) as tgeom_extring  
FROM oq_sample.oq_s1b_building_extring ORDER BY grp_poly;

grp_poly|nodes                                                                                                                                                                                                                                                          |ways_id                                                                          |geom_extring                                                                                                                                                                                                                                                   |tgeom_extring                                                                                                                                                                                                                                                  |
--------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
       1|{6204502184,6204502183,6204502182,6204502181,6204502180,6204502486,6204502485,6204502184}                                                                                                                                                                      |{662766881,662766880}                                                            |LINESTRING (-79.439676 43.691105, -79.439656 43.691056, -79.439821 43.69102, -79.439965 43.690989, -79.44004 43.691171, -79.439572 43.691272, -79.439518 43.691139, -79.439676 43.691105)                                                                      |LINESTRING(-79.439676 43.691105,-79.439656 43.691056,-79.439821 43.69102,-79.439965 43.690989,-79.44004 43.691171,-79.439572 43.691272,-79.439518 43.691139,-79.439676 43.691105)                                                                              |
       2|{6196761077,6196761076,6196761075,6196761074,6196761073,6204499301,6204499300,6204499299,6196761072,6196761071,6196761070,6196761069,6196761077}                                                                                                               |{661895300,662766701}                                                            |LINESTRING (-79.438972 43.691825, -79.438937 43.691803, -79.438953 43.691789, -79.438936 43.691779, -79.438964 43.691754, -79.438906 43.691719, -79.438875 43.691664, -79.43891 43.691634, -79.439024 43.691703, -79.439076 43.691735, -79.439034 43.691772, -7|LINESTRING(-79.438972 43.691825,-79.438937 43.691803,-79.438953 43.691789,-79.438936 43.691779,-79.438964 43.691754,-79.438906 43.691719,-79.438875 43.691664,-79.43891 43.691634,-79.439024 43.691703,-79.439076 43.691735,-79.439034 43.691772,-79.438988 43.|
       3|{6204502597,6204502590,6204502589,6204502588,6204502596,6204502595,6204502594,6204502593,6204502592,6204502591,6204502598,6204502597}                                                                                                                          |{662766896,662766895}                                                            |LINESTRING (-79.440497 43.691625, -79.440453 43.691523, -79.44084 43.691435, -79.440884 43.691537, -79.440712 43.691576, -79.440748 43.691659, -79.440673 43.691676, -79.440679 43.691691, -79.440754 43.691674, -79.440771 43.691712, -79.440556 43.691761, -7|LINESTRING(-79.440497 43.691625,-79.440453 43.691523,-79.44084 43.691435,-79.440884 43.691537,-79.440712 43.691576,-79.440748 43.691659,-79.440673 43.691676,-79.440679 43.691691,-79.440754 43.691674,-79.440771 43.691712,-79.440556 43.691761,-79.440497 43.|
       4|{6196764375,6196764374,6196764373,6196764376,6196764375}                                                                                                                                                                                                       |{661894732,661895469}                                                            |LINESTRING (-79.439644 43.692483, -79.439553 43.692265, -79.439861 43.692197, -79.440173 43.692367, -79.439644 43.692483)                                                                                                                                      |LINESTRING(-79.439644 43.692483,-79.439553 43.692265,-79.439861 43.692197,-79.440173 43.692367,-79.439644 43.692483)                                                                                                                                           |
       5|{6196764971,6196764414,6196764413,6196764412,6196764411,6196764970,6196764969,6196764968,6196764978,6196764977,6196764976,6196765087,6196765086,6196765085,6196765093,6196765092,6196765091,6196765090,6196765100,6196765099,6196765098,6196765097,6196765096,6|{661895510,661895473,661895512,661895513,661895514}                              |LINESTRING (-79.440614 43.691906, -79.440597 43.691866, -79.440777 43.691826, -79.44079 43.691857, -79.440709 43.691876, -79.440713 43.691884, -79.441001 43.691818, -79.441057 43.691949, -79.44105 43.691951, -79.441061 43.691976, -79.440988 43.691992, -79|LINESTRING(-79.440614 43.691906,-79.440597 43.691866,-79.440777 43.691826,-79.44079 43.691857,-79.440709 43.691876,-79.440713 43.691884,-79.441001 43.691818,-79.441057 43.691949,-79.44105 43.691951,-79.441061 43.691976,-79.440988 43.691992,-79.440994 43.6|
       6|{6196764421,6196751573,6196764378,6196764377,6196764376,6196764415,6196764420,6196764430,6196764419,6196764418,6196764417,6196764416,6196764428,6196764427,6196764426,6196764425,6196764424,6196764423,6196764422,6196764421}                                  |{661895475,661895469,661895474,661894732}                                        |LINESTRING (-79.440155 43.692517, -79.4401261 43.6924491, -79.439781 43.692527, -79.43975 43.69246, -79.440173 43.692367, -79.440264 43.692418, -79.440355 43.692472, -79.440508 43.692555, -79.440329 43.692595, -79.440336 43.692612, -79.440286 43.692623, -|LINESTRING(-79.440155 43.692517,-79.4401261 43.6924491,-79.439781 43.692527,-79.43975 43.69246,-79.440173 43.692367,-79.440264 43.692418,-79.440355 43.692472,-79.440508 43.692555,-79.440329 43.692595,-79.440336 43.692612,-79.440286 43.692623,-79.440282 43|
       7|{6028524857,6196765159,6196765155,6196765154,6196765150,6196765145,6196765141,6196765135,6196765131,6196765130,6196765129,6196765134,6196765133,6196765132,6196765140,6196765139,6196765138,6196765137,6196765136,6196765144,6196765143,6196765142,6196765149,6|{661895520,639843855,661895517,661895518,661895519,661895521,661895522,661894733}|LINESTRING (-79.441045 43.692606, -79.440999 43.692586, -79.440942 43.692561, -79.440914 43.69251, -79.440894 43.692472, -79.44087 43.692429, -79.440849 43.69239, -79.440826 43.692346, -79.440799 43.692297, -79.441013 43.692248, -79.441034 43.692287, -79.|LINESTRING(-79.441045 43.692606,-79.440999 43.692586,-79.440942 43.692561,-79.440914 43.69251,-79.440894 43.692472,-79.44087 43.692429,-79.440849 43.69239,-79.440826 43.692346,-79.440799 43.692297,-79.441013 43.692248,-79.441034 43.692287,-79.441028 43.69|
       8|{6196764439,6196764438,6196764437,6196764436,6196764435,6196764434,6196764433,6196764432,6196764431,6196764430,6196764429,6196764439}                                                                                                                          |{661895474,661895475}                                                            |LINESTRING (-79.440426 43.692694, -79.440421 43.692683, -79.440384 43.692692, -79.440369 43.692656, -79.44041 43.692647, -79.440514 43.692623, -79.440505 43.692601, -79.440372 43.692631, -79.440355 43.69259, -79.440508 43.692555, -79.440659 43.692642, -79|LINESTRING(-79.440426 43.692694,-79.440421 43.692683,-79.440384 43.692692,-79.440369 43.692656,-79.44041 43.692647,-79.440514 43.692623,-79.440505 43.692601,-79.440372 43.692631,-79.440355 43.69259,-79.440508 43.692555,-79.440659 43.692642,-79.440426 43.6|
       9|{6196765177,6028524862,6028524857,6196751576,6196751575,6028524861,6196765174,6196765173,6196765175,6028524864,6028524865,6028524863,6028524866,6196765181,6196765180,6196765179,6196765178,6196765189,6196765188,6196765187,6196765186,6196765185,6196765184,6|{661894733,661895524,639843862,639843863,639843858,639843857,639843855,639843859}|LINESTRING (-79.441132 43.692644, -79.441087 43.692624, -79.441045 43.692606, -79.4411536 43.6924745, -79.4411882 43.6924924, -79.4411749 43.6925071, -79.441191 43.692514, -79.441204 43.692498, -79.441239 43.692514, -79.44125 43.692501, -79.44131 43.69252|LINESTRING(-79.441132 43.692644,-79.441087 43.692624,-79.441045 43.692606,-79.4411536 43.6924745,-79.4411882 43.6924924,-79.4411749 43.6925071,-79.441191 43.692514,-79.441204 43.692498,-79.441239 43.692514,-79.44125 43.692501,-79.44131 43.692527,-79.44129|
      10|{6196791962,6196791961,6196791960,6196791959,6196791958,6196791957,6196791956,6196791955,6196791967,6196791954,6196791962}                                                                                                                                     |{661896968,661896969}                                                            |LINESTRING (-79.444218 43.693736, -79.444175 43.693631, -79.444192 43.693627, -79.444184 43.69361, -79.444201 43.693606, -79.444199 43.693601, -79.444228 43.693595, -79.444237 43.693617, -79.444251 43.693652, -79.44428 43.693722, -79.444218 43.693736)    |LINESTRING(-79.444218 43.693736,-79.444175 43.693631,-79.444192 43.693627,-79.444184 43.69361,-79.444201 43.693606,-79.444199 43.693601,-79.444228 43.693595,-79.444237 43.693617,-79.444251 43.693652,-79.44428 43.693722,-79.444218 43.693736)               |
      11|{6196791968,6196791967,6196791966,6196791965,6196791964,6196791963,6196791968}                                                                                                                                                                                 |{661896968,661896969}                                                            |LINESTRING (-79.444294 43.693754, -79.444251 43.693652, -79.444242 43.693629, -79.444303 43.693615, -79.444311 43.693635, -79.444355 43.693741, -79.444294 43.693754)                                                                                          |LINESTRING(-79.444294 43.693754,-79.444251 43.693652,-79.444242 43.693629,-79.444303 43.693615,-79.444311 43.693635,-79.444355 43.693741,-79.444294 43.693754)                                                                                                 |
      
drop table IF EXISTS temp_fjson;
create temporary table temp_fjson as 
SELECT public.OQ_PostGIS2Json('oq_sample','oq_s1b_building_extring','geom_extring') as tjson;
copy (select tjson from temp_fjson) TO 'd:/temp/oq_s1b_building_extring.geojson' encoding 'utf-8'; 


/*	OQ_Calc_Classify_Angles
	Internal Function for OQ_Orthogonal
	It returns arrays for linestring/Polygons angles
*/

SELECT grp_poly, (public.OQ_Calc_Classify_Angles(geom_extring)).* 
FROM oq_sample.oq_s1b_building_extring;

grp_poly|k_angle_deb|k_angle_end|l_point                                                                                                                                                                                                                                                        |lv_azimuth                                                                                                                                                                                                                                                     |lp_angle                                                                                                                                                                                                         |lp_tpolygon                                                                                |
--------|-----------|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
       1|          1|          1|{'POINT (-79.439676 43.691105)','POINT (-79.439656 43.691056)','POINT (-79.439821 43.69102)','POINT (-79.439965 43.690989)','POINT (-79.44004 43.691171)','POINT (-79.439572 43.691272)','POINT (-79.439518 43.691139)','POINT (-79.439676 43.691105)'}        |{2.8536509201009133,-1.8628777231712506,-1.8592033551761151,-0.29055728126922215,1.2817081270633786,2.8550849857955454,-1.8590924619562814,2.8536509201009133}                                                                                                 |{90,90.2,179.8,90.1,89.9,89.9,90.1,90}                                                                                                                                                                           |{o,o,i,o,o,o,o}                                                                            |
       2|          1|          1|{'POINT (-79.438972 43.691825)','POINT (-79.438937 43.691803)','POINT (-79.438953 43.691789)','POINT (-79.438936 43.691779)','POINT (-79.438964 43.691754)','POINT (-79.438906 43.691719)','POINT (-79.438875 43.691664)','POINT (-79.43891 43.691634)','POINT |{2.2846556155580227,-2.449255356930504,2.2520109858975235,-2.459162755484407,2.2645325925493203,2.7533661359485486,-2.439103779153375,-0.8755828413995278,-0.8674134689323405,0.6890081124579384,0.7078815446831576,0.6923369223849495,2.2846556155580227}     |{88.8,91.2,89.4,89.9,90.6,152,117.5,90.4,179.5,90.8,178.9,179.1,88.8}                                                                                                                                            |{o,o,o,o,o,ir,ir,o,i,o,i,i}                                                                |
       3|          1|          1|{'POINT (-79.440497 43.691625)','POINT (-79.440453 43.691523)','POINT (-79.44084 43.691435)','POINT (-79.440884 43.691537)','POINT (-79.440712 43.691576)','POINT (-79.440748 43.691659)','POINT (-79.440673 43.691676)','POINT (-79.440679 43.691691)','POINT |{2.8382419968816257,-1.874475481831514,-0.3033505476807813,1.2679242965508197,-0.30491042874994734,1.2680216822740202,-0.28248436534755744,-1.8735701385922823,-0.31388560017385575,1.266463911267809,2.8366235276496754,2.8382419968816257}                   |{179.9,90,90,90,89.9,89.9,91.2,88.8,90.6,89.5,90,179.9}                                                                                                                                                          |{i,o,o,o,o,o,o,o,o,o,o}                                                                    |
       4|          1|          1|{'POINT (-79.439644 43.692483)','POINT (-79.439553 43.692265)','POINT (-79.439861 43.692197)','POINT (-79.440173 43.692367)','POINT (-79.439644 43.692483)'}                                                                                                   |{2.8474852131266086,-1.866161945716244,-0.9267062987490682,1.277314828232099,2.8474852131266086}                                                                                                                                                               |{90,90.1,126.2,53.7,90}                                                                                                                                                                                          |{o,o,ir,ir}                                                                                |
       5|          1|          1|{'POINT (-79.440614 43.691906)','POINT (-79.440597 43.691866)','POINT (-79.440777 43.691826)','POINT (-79.44079 43.691857)','POINT (-79.440709 43.691876)','POINT (-79.440713 43.691884)','POINT (-79.441001 43.691818)','POINT (-79.441057 43.691949)','POINT |{2.8424605789394866,-1.867980066313927,-0.2953873238228858,1.2581307170650697,-0.3480377581031638,-1.8767056250818488,-0.30077466357052496,1.1956839650830535,-0.3090398135345341,1.2774504372325304,-0.28248294510894467,-1.8809521370148568,-0.30149589418412|{179.9,89.9,89.9,91,88,92.4,89.7,94.3,93.8,89.1,90.6,88.4,89.5,89.8,89.7,89.7,174.7,163.6,173.9,168,177.9,148.3,89.2,90.2,89.8,88.3,88.5,94,109.2,179.3,70.5,84.8,91.9,91.6,179.9}                               |{i,o,o,o,o,oo,o,oo,oo,o,o,o,o,o,o,o,rr,rr,rr,r,ii,ir,o,o,o,o,o,oo,ir,i,ir,ir,o,o}          |
       6|          1|          1|{'POINT (-79.440155 43.692517)','POINT (-79.4401261 43.6924491)','POINT (-79.439781 43.692527)','POINT (-79.43975 43.69246)','POINT (-79.440173 43.692367)','POINT (-79.440264 43.692418)','POINT (-79.440355 43.692472)','POINT (-79.440508 43.692555)','POINT|{2.842048652586151,1.269190571462838,2.8176884023878666,-1.8649998828675052,-0.9131284844862468,-0.8852900175791306,-0.9288132461797125,1.2720435217296762,-0.2903353835177327,1.2764099321557931,2.7935588254854906,1.2641756689361572,2.829632122514781,2.837|{90.5,89.9,91.3,88.3,125.5,178.4,177.5,53.9,90.5,90.2,93.1,92.4,90.3,179.5,89.6,179.2,90.2,89.6,179.2,90.5}                                                                                                      |{o,o,o,o,ir,i,ii,ir,o,o,oo,oo,o,i,o,i,o,o,i}                                               |
       7|          1|          1|{'POINT (-79.441045 43.692606)','POINT (-79.440999 43.692586)','POINT (-79.440942 43.692561)','POINT (-79.440914 43.69251)','POINT (-79.440894 43.692472)','POINT (-79.44087 43.692429)','POINT (-79.440849 43.69239)','POINT (-79.440826 43.692346)','POINT (-|{2.1106277517372005,2.1144860965805607,2.7624909651062577,2.776788437949958,2.756792406891533,2.7691193636000904,2.779062128421886,2.761237410336798,-1.8764640902078713,-0.37247384482831486,1.1401652928860173,-0.36573048674079467,1.190911122280744,-0.3930|{89.8,179.8,142.9,179.2,178.9,179.3,179.4,179,85.7,93.8,93.3,93.7,90.8,89.2,91.1,94.4,95.1,90.7,102,102.5,90.7,89.1,90.9,178.6,91.8,92.7,55.5,179.9,90.8,177.9,178.5,89.8}                                       |{o,i,ir,i,i,i,i,i,oo,oo,oo,oo,o,o,o,oo,ir,o,ir,ir,o,o,o,i,o,oo,ir,i,o,ii,i}                |
       8|          1|          1|{'POINT (-79.440426 43.692694)','POINT (-79.440421 43.692683)','POINT (-79.440384 43.692692)','POINT (-79.440369 43.692656)','POINT (-79.44041 43.692647)','POINT (-79.440514 43.692623)','POINT (-79.440505 43.692601)','POINT (-79.440372 43.692631)','POINT |{2.8230078184834135,1.2473403187630672,2.847995273212773,-1.8645665392245683,-1.8787175124031128,2.8530392793319765,1.2694020567024498,2.84934680534855,-1.8761979228861934,-0.8996989557899777,1.272404973832941,2.8230078184834135}                          |{91.2,89.7,88.3,90,179.2,91.1,89.3,89.5,90.8,124.1,55.5,91.2}                                                                                                                                                    |{o,o,o,o,i,o,o,o,o,ir,ir}                                                                  |
       9|          1|          1|{'POINT (-79.441132 43.692644)','POINT (-79.441087 43.692624)','POINT (-79.441045 43.692606)','POINT (-79.4411536 43.6924745)','POINT (-79.4411882 43.6924924)','POINT (-79.4411749 43.6925071)','POINT (-79.441191 43.692514)','POINT (-79.441204 43.692498)',|{2.1203683165508096,2.1043055734079186,-2.601728049790521,-0.951412806224962,0.5809309992399306,-1.0372874979609603,-2.608889204659707,-1.0085979401261094,-2.5909616839980245,-1.0324358286965172,0.5399874028179027,0.5320673883858658,-0.9674360949122597,-2|{179.3,179.1,89.6,85.4,92.2,87.3,90,88.3,89.3,90.7,89.9,179.5,94.1,86.2,90.9,88.9,88.9,91.2,179.6,89.8,89.2,86.9,93.1,179,89.4,90.3,90.1,90.4,78.6,167.2,89,89.9,90.4,99.1,98.8,90,179.8,179.7,178.9,179.4,179.3}|{i,i,o,oo,oo,oo,o,o,o,o,o,i,oo,oo,o,o,o,o,i,o,o,oo,oo,i,o,o,o,o,ir,r,o,o,o,ir,ir,o,i,i,i,i}|
      10|          1|          1|{'POINT (-79.444218 43.693736)','POINT (-79.444175 43.693631)','POINT (-79.444192 43.693627)','POINT (-79.444184 43.69361)','POINT (-79.444201 43.693606)','POINT (-79.444199 43.693601)','POINT (-79.444228 43.693595)','POINT (-79.444237 43.693617)','POINT |{2.8527553334329347,-1.8843759016424129,2.8125505472243724,-1.8843757981927727,2.8591168673600564,-1.84856642056965,-0.28854871275812255,-0.2824755472646914,-0.29200873296690816,1.2690924042900915,2.8527553334329347}                                       |{89.3,91.4,89.1,89.1,91.8,89.7,90.6,179.7,179.5,90.6,89.3}                                                                                                                                                       |{o,o,o,o,o,o,o,i,i,o}                                                                      |
      11|          1|          1|{'POINT (-79.444294 43.693754)','POINT (-79.444251 43.693652)','POINT (-79.444242 43.693629)','POINT (-79.444303 43.693615)','POINT (-79.444311 43.693635)','POINT (-79.444355 43.693741)','POINT (-79.444294 43.693754)'}                                     |{2.8447441703376044,2.864946063253854,-1.8771434741980348,-0.2824756250157724,-0.29254665777349553,1.2851175974392595,2.8447441703376044}                                                                                                                      |{90.6,178.8,91.7,88.6,179.4,89.6,90.6}                                                                                                                                                                           |{o,i,o,o,i,o}                                                                              |

/*  OQ_Circular_list_select_next
	Internal Function for OQ_Orthogonal
	Finds Prev / Next k (+-variation) to process in process lists
	ie k-1, k-2, k+2
*/

WITH circular  AS (
SELECT circular_list::integer[], kp, variation
FROM (VALUES
('{1, 3, 7, 9, 10,11}', 2, 3),
('{1, 3, 7, 9, 10,11}',2,4),
('{1, 3, 7, 9, 10,11}',2,5),
('{1, 3, 7, 9, 10,11}',2,-2),
('{1, 3, 7, 9, 10,11}',2,-3),
('{1, 3, 7, 9, 10,11}',2,-4),
('{1, 3, 7, 9, 10,11}',2,-5)
)  AS c (circular_list, kp, variation)
)
SELECT circular_list, kp, variation, public.OQ_Circular_list_select_next(circular_list, kp, variation)
from circular;

circular_list  |kp|variation|oq_circular_list_select_next|
---------------|--|---------|----------------------------|
{1,3,7,9,10,11}| 2|        3|                           5|
{1,3,7,9,10,11}| 2|        4|                           6|
{1,3,7,9,10,11}| 2|        5|                           1|
{1,3,7,9,10,11}| 2|       -2|                           6|
{1,3,7,9,10,11}| 2|       -3|                           5|
{1,3,7,9,10,11}| 2|       -4|                           4|
{1,3,7,9,10,11}| 2|       -5|                           3|


/*	OQ_OrthogonalProcessPoints
	Internal Function for OQ_Orthogonal
	It returns arrays for points to process
	lk_process_s1		points except near 180
	lk_process_180_s2,  points near 180
	lk_prev_s1			for S2, ref to prev s1.point
	lk_next_s1			for S2, ref to next s1.point
*/	

WITH angles AS (
SELECT k_angle_deb, tolerance_max, lp_angle
FROM (VALUES
(1, 10.0, '{178.6,89.8,87.3,87.8,178.5,88.5,89.2,178.2,87,88.5,91.6,178.6}'::float[]),
(2, 10.0, '{178.6,89.8,87.3,87.8,178.5,88.5,89.2,178.2,87,88.5,91.6,178.6, 88.9}'::float[])
) AS a (k_angle_deb, tolerance_max, lp_angle)
)
SELECT k_angle_deb, tolerance_max, lp_angle,
	 (public.OQ_OrthogonalProcessPoints(k_angle_deb, tolerance_max, lp_angle)).*
FROM angles;

k_angle_deb|tolerance_max|lp_angle                                                            |lk_process_s1      |lk_process_180_s2|lk_prev_s1                |lk_next_s1              |
-----------|-------------|--------------------------------------------------------------------|-------------------|-----------------|--------------------------|------------------------|
          1|         10.0|{178.6,89.8,87.3,87.8,178.5,88.5,89.2,178.2,87,88.5,91.6,178.6}     |{2,3,4,6,7,9,10,11}|{1,5,8}          |{11,2,3,4,4,6,7,7,9,10,11}|{2,2,3,4,6,6,7,9,9,10,2}|
          2|         10.0|{178.6,89.8,87.3,87.8,178.5,88.5,89.2,178.2,87,88.5,91.6,178.6,88.9}|{2,3,4,6,7,9,10,11}|{5,8}            |{2,3,4,4,6,7,7,9,10,11}   |{2,3,4,6,6,7,9,9,10,11} |

/*	OQ_Calc_Classify_Angles
	input : linestring
*/

WITH angles AS (
SELECT grp_poly, ST_AsText(geom_extring,7) as tgeom, (public.OQ_Calc_Classify_Angles(geom_extring)).* 
FROM oq_sample.oq_s1b_building_extring ORDER BY grp_poly
)
SELECT grp_poly, k_angle_deb, lp_angle, (public.OQ_OrthogonalProcessPoints(1, 10.0, lp_angle)).*
from angles;

grp_poly|k_angle_deb|lp_angle                                                                                                                                                                                                         |lk_process_s1                                                                          |lk_process_180_s2         |lk_prev_s1                                                                                                       |lk_next_s1                                                                                                     |
--------|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|
       1|          1|{90,90.2,179.8,90.1,89.9,89.9,90.1,90}                                                                                                                                                                           |{1,2,4,5,6,7}                                                                          |{3}                       |{7,2,2,4,5,6,7}                                                                                                  |{1,2,4,4,5,6,1}                                                                                                |
       2|          1|{88.8,91.2,89.4,89.9,90.6,152,117.5,90.4,179.5,90.8,178.9,179.1,88.8}                                                                                                                                            |{1,2,3,4,5,6,7,8,10}                                                                   |{9,11,12}                 |{10,2,3,4,5,6,7,8,8,10,10,10}                                                                                    |{1,2,3,4,5,6,7,8,10,10,10,1}                                                                                   |
       3|          1|{179.9,90,90,90,89.9,89.9,91.2,88.8,90.6,89.5,90,179.9}                                                                                                                                                          |{2,3,4,5,6,7,8,9,10,11}                                                                |{1}                       |{11,2,3,4,5,6,7,8,9,10,11}                                                                                       |{2,2,3,4,5,6,7,8,9,10,2}                                                                                       |
       4|          1|{90,90.1,126.2,53.7,90}                                                                                                                                                                                          |{1,2,3,4}                                                                              |{}                        |{4,2,3,4}                                                                                                        |{1,2,3,1}                                                                                                      |
       5|          1|{179.9,89.9,89.9,91,88,92.4,89.7,94.3,93.8,89.1,90.6,88.4,89.5,89.8,89.7,89.7,174.7,163.6,173.9,168,177.9,148.3,89.2,90.2,89.8,88.3,88.5,94,109.2,179.3,70.5,84.8,91.9,91.6,179.9}                               |{2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,20,22,23,24,25,26,27,28,29,31,32,33,34}       |{1,17,19,21,30}           |{34,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,16,18,18,20,20,22,23,24,25,26,27,28,29,29,31,32,33,34}                  |{2,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,18,20,20,22,22,23,24,25,26,27,28,29,31,31,32,33,2}                  |
       6|          1|{90.5,89.9,91.3,88.3,125.5,178.4,177.5,53.9,90.5,90.2,93.1,92.4,90.3,179.5,89.6,179.2,90.2,89.6,179.2,90.5}                                                                                                      |{1,2,3,4,5,8,9,10,11,12,13,15,17,18}                                                   |{6,7,14,16,19}            |{18,2,3,4,5,5,5,8,9,10,11,12,13,13,15,15,17,18,18}                                                               |{1,2,3,4,5,8,8,8,9,10,11,12,13,15,15,17,17,18,1}                                                               |
       7|          1|{89.8,179.8,142.9,179.2,178.9,179.3,179.4,179,85.7,93.8,93.3,93.7,90.8,89.2,91.1,94.4,95.1,90.7,102,102.5,90.7,89.1,90.9,178.6,91.8,92.7,55.5,179.9,90.8,177.9,178.5,89.8}                                       |{1,3,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,25,26,27,29}                          |{2,4,5,6,7,8,24,28,30,31} |{29,1,3,3,3,3,3,3,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,23,25,26,27,27,29,29,29}                           |{1,3,3,9,9,9,9,9,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,25,25,26,27,29,29,29,1}                           |
       8|          1|{91.2,89.7,88.3,90,179.2,91.1,89.3,89.5,90.8,124.1,55.5,91.2}                                                                                                                                                    |{1,2,3,4,6,7,8,9,10,11}                                                                |{5}                       |{11,2,3,4,4,6,7,8,9,10,11}                                                                                       |{1,2,3,4,6,6,7,8,9,10,1}                                                                                       |
       9|          1|{179.3,179.1,89.6,85.4,92.2,87.3,90,88.3,89.3,90.7,89.9,179.5,94.1,86.2,90.9,88.9,88.9,91.2,179.6,89.8,89.2,86.9,93.1,179,89.4,90.3,90.1,90.4,78.6,167.2,89,89.9,90.4,99.1,98.8,90,179.8,179.7,178.9,179.4,179.3}|{3,4,5,6,7,8,9,10,11,13,14,15,16,17,18,20,21,22,23,25,26,27,28,29,30,31,32,33,34,35,36}|{1,2,12,19,24,37,38,39,40}|{36,0,3,4,5,6,7,8,9,10,11,11,13,14,15,16,17,18,18,20,21,22,23,23,25,26,27,28,29,30,31,32,33,34,35,36,36,36,36,36}|{3,3,3,4,5,6,7,8,9,10,11,13,13,14,15,16,17,18,20,20,21,22,23,25,25,26,27,28,29,30,31,32,33,34,35,36,36,36,36,3}|
      10|          1|{89.3,91.4,89.1,89.1,91.8,89.7,90.6,179.7,179.5,90.6,89.3}                                                                                                                                                       |{1,2,3,4,5,6,7,10}                                                                     |{8,9}                     |{10,2,3,4,5,6,7,7,7,10}                                                                                          |{1,2,3,4,5,6,7,10,10,1}                                                                                        |
      11|          1|{90.6,178.8,91.7,88.6,179.4,89.6,90.6}                                                                                                                                                                           |{1,3,4,6}                                                                              |{2,5}                     |{6,1,3,4,4,6}                                                                                                    |{1,3,3,4,6,1}                                                                                                  |

/* OQ_Orthogonal  
	Input Ways table
	Output Eval JSON variable 
	{  "grptag":"", 
	"flag":"0",  	 -- 0 orthogonal, otherwise 1
	"npoints": "8",  -- nb_points in polygon
	"tpolygon": "r", -- classif. of polygon geometry
	"nb_angles": 6,  -  nb_angles in polygon
	"angles": "{90,90.2,179.8,90.1,89.9,89.9,90.1,90}", 
	"angles_r": "{90,90.1,179.9,90.1,89.9,89.9,90.1,90}", 
	"lp_tpolygon": "{o,o,i,o,o,o,o}", -- classif each angle
	"linestring": "LINESTRING(-79.439676 43.691105,-79.439656 43.691056,-79.439821 43.69102,-79.439965 43.690989,-79.44004 43.691171,-79.439572 43.691272,-79.439518 43.691139,-79.439676 43.691105)", 
	"linestring_r": "LINESTRING(-79.439676 43.691105,-79.439656 43.691056,-79.439821 43.6910202,-79.439965 43.690989,-79.44004 43.691171,-79.439572 43.691272,-79.439518 43.691139,-79.439676 43.691105)", 
	"segments_q_rev": "", "segments_d_rev": "", "segments_p0_rev": "", 
	"lk_S1":"{1,2,4,5,6,7}", "lk_180_S2": "{3}"
	}
*/

DROP TABLE IF EXISTS oq_sample.oq_s1a_building_orthogonal;
CREATE TABLE oq_sample.oq_s1a_building_orthogonal AS
with grp_buildings AS (
SELECT id, 
public.OQ_Orthogonal(id::bigint, 
linestring, 1.0, 10.0) as eval
FROM oq_sample.oq_s1a_building
),
revs as (
SELECT id, eval
, eval->>'angles' as angles,
eval->>'angles_r' as angles_r,
ST_GeomFromText((eval->>'linestring'), 4326) as linestring,
(eval->>'linestring_r') as tlinestring_r,
ST_GeomFromText((eval->>'linestring_r'), 4326) as linestring_r,
(eval->>'segments_q_rev') as t_segments_q_rev,
(eval->>'segments_d_rev') as t_segments_d_rev,
(eval->>'segments_p0_rev') as t_segments_p0_rev,
(eval->>'lk_S1') as lk_S1,
(eval->>'lk_180_S2') as lk_180_S2, 
CASE WHEN NOT (eval->>'segments_q_rev') ~ 'MULTILINESTRING' 
	THEN NULL 
ELSE ST_GeomFromText((eval->>'segments_q_rev'), 4326) 
END AS segments_q_rev, 
CASE WHEN NOT (eval->>'segments_d_rev') ~ 'MULTILINESTRING' 
	THEN NULL 
ELSE ST_GeomFromText((eval->>'segments_d_rev'), 4326) 
END AS segments_d_rev, 
CASE WHEN NOT (eval->>'segments_p0_rev') ~ 'MULTILINESTRING' 
	THEN NULL 
ELSE ST_GeomFromText((eval->>'segments_p0_rev'), 4326) 
END AS segments_p0_rev
FROM grp_buildings
WHERE (eval->>'linestring_r')<>'' 
)
SELECT * FROM revs;

drop table IF EXISTS temp_fjson;
create temporary table temp_fjson as 
SELECT public.OQ_PostGIS2Json('oq_sample','oq_s1a_building_orthogonal','linestring_r') as tjson;
copy (select tjson from temp_fjson) TO 'd:/temp/oq_s1a_building_orthogonal.geojson' encoding 'utf-8'; 

DROP TABLE IF EXISTS oq_sample.oq_s1b_building_extring_orthogonal;
CREATE TABLE oq_sample.oq_s1b_building_extring_orthogonal AS
with grp_buildings AS (
SELECT grp_poly, 
public.OQ_Orthogonal(grp_poly::bigint, 
geom_extring, 1.0, 10.0) as eval
FROM oq_sample.oq_s1b_building_extring
),
revs as (
SELECT grp_poly, eval
, eval->>'angles' as angles,
eval->>'angles_r' as angles_r,
ST_GeomFromText((eval->>'linestring'), 4326) as linestring,
(eval->>'linestring_r') as tlinestring_r,
ST_GeomFromText((eval->>'linestring_r'), 4326) as linestring_r,
(eval->>'segments_q_rev') as t_segments_q_rev,
(eval->>'segments_d_rev') as t_segments_d_rev,
(eval->>'segments_p0_rev') as t_segments_p0_rev,
(eval->>'lk_S1') as lk_S1,
(eval->>'lk_180_S2') as lk_180_S2, 
CASE WHEN NOT (eval->>'segments_q_rev') ~ 'MULTILINESTRING' 
	THEN NULL 
ELSE ST_GeomFromText((eval->>'segments_q_rev'), 4326) 
END AS segments_q_rev, 
CASE WHEN NOT (eval->>'segments_d_rev') ~ 'MULTILINESTRING' 
	THEN NULL 
ELSE ST_GeomFromText((eval->>'segments_d_rev'), 4326) 
END AS segments_d_rev, 
CASE WHEN NOT (eval->>'segments_p0_rev') ~ 'MULTILINESTRING' 
	THEN NULL 
ELSE ST_GeomFromText((eval->>'segments_p0_rev'), 4326) 
END AS segments_p0_rev
FROM grp_buildings
WHERE (eval->>'linestring_r')<>'' 
)
SELECT * FROM revs;

SELECT * FROM oq_sample.oq_s1b_building_extring_orthogonal limit 10;

grp_poly|eval                                                                                                                                                                                                                                                           |angles                                                                                                                                                                                                                                                         |angles_r                                                                                                                                                                                                                                                       |linestring                                                                                                                                                                                                                                                     |tlinestring_r                                                                                                                                                                                                                                                  |linestring_r                                                                                                                                                                                                                                                   |t_segments_q_rev|t_segments_d_rev|t_segments_p0_rev|lk_s1                                                                           |lk_180_s2                |segments_q_rev|segments_d_rev|segments_p0_rev|
--------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------|----------------|-----------------|--------------------------------------------------------------------------------|-------------------------|--------------|--------------|---------------|
       1|{  "grptag":"", "flag":"0","npoints": "8", "tpolygon": "r", "nb_angles": 6, "angles": "{90,90.2000000000000028,179.800000000000011,90.0999999999999943,89.9000000000000057,89.9000000000000057,90.0999999999999943,90}", "angles_r": "{90,90.0999999999999943,1|{90,90.2000000000000028,179.800000000000011,90.0999999999999943,89.9000000000000057,89.9000000000000057,90.0999999999999943,90}                                                                                                                                |{90,90.0999999999999943,179.900000000000006,90.0999999999999943,89.9000000000000057,89.9000000000000057,90.0999999999999943,90}                                                                                                                                |LINESTRING (-79.439676 43.691105, -79.439656 43.691056, -79.439821 43.69102, -79.439965 43.690989, -79.44004 43.691171, -79.439572 43.691272, -79.439518 43.691139, -79.439676 43.691105)                                                                      |LINESTRING(-79.439676 43.691105,-79.439656 43.691056,-79.439821 43.6910202,-79.439965 43.690989,-79.44004 43.691171,-79.439572 43.691272,-79.439518 43.691139,-79.439676 43.691105)                                                                            |LINESTRING (-79.439676 43.691105, -79.439656 43.691056, -79.439821 43.6910202, -79.439965 43.690989, -79.44004 43.691171, -79.439572 43.691272, -79.439518 43.691139, -79.439676 43.691105)                                                                    |                |                |                 |{1,2,4,5,6,7}                                                                   |{3}                      |              |              |               |
       2|{  "grptag":"", "flag":"0","npoints": "13", "tpolygon": "nd", "nb_angles": 9, "angles": "{88.7999999999999972,91.2000000000000028,89.4000000000000057,89.9000000000000057,90.5999999999999943,152,117.5,90.4000000000000057,179.5,90.7999999999999972,178.90000|{88.7999999999999972,91.2000000000000028,89.4000000000000057,89.9000000000000057,90.5999999999999943,152,117.5,90.4000000000000057,179.5,90.7999999999999972,178.900000000000006,179.099999999999994,88.7999999999999972}                                      |{0.299999999999999989,89.0999999999999943,1.89999999999999991,89.7999999999999972,91.2000000000000028,153,117.299999999999997,90.4000000000000057,179.5,90.7999999999999972,178.900000000000006,179.099999999999994,88.7999999999999972}                       |LINESTRING (-79.438972 43.691825, -79.438937 43.691803, -79.438953 43.691789, -79.438936 43.691779, -79.438964 43.691754, -79.438906 43.691719, -79.438875 43.691664, -79.43891 43.691634, -79.439024 43.691703, -79.439076 43.691735, -79.439034 43.691772, -7|LINESTRING(-79.438972 43.691825,-79.438937 43.691803,-79.438953 43.691789,-79.438936 43.691779,-79.4389638 43.6917543,-79.4389062 43.6917187,-79.438875 43.691664,-79.43891 43.691634,-79.4390238 43.6917033,-79.439076 43.691735,-79.439076 43.691735,-79.4389|LINESTRING (-79.438972 43.691825, -79.438937 43.691803, -79.438953 43.691789, -79.438936 43.691779, -79.4389638 43.6917543, -79.4389062 43.6917187, -79.438875 43.691664, -79.43891 43.691634, -79.4390238 43.6917033, -79.439076 43.691735, -79.439076 43.6917|                |                |                 |{1,2,3,4,5,6,7,8,10}                                                            |{9,11,12}                |              |              |               |
       3|{  "grptag":"", "flag":"0","npoints": "12", "tpolygon": "r", "nb_angles": 10, "angles": "{179.900000000000006,90,90,90,89.9000000000000057,89.9000000000000057,91.2000000000000028,88.7999999999999972,90.5999999999999943,89.5,90,179.900000000000006}", "angl|{179.900000000000006,90,90,90,89.9000000000000057,89.9000000000000057,91.2000000000000028,88.7999999999999972,90.5999999999999943,89.5,90,179.900000000000006}                                                                                                 |{179.900000000000006,90,90,90,89.9000000000000057,89.9000000000000057,91.2000000000000028,88.7999999999999972,90.0999999999999943,89.9000000000000057,90,179.900000000000006}                                                                                  |LINESTRING (-79.440497 43.691625, -79.440453 43.691523, -79.44084 43.691435, -79.440884 43.691537, -79.440712 43.691576, -79.440748 43.691659, -79.440673 43.691676, -79.440679 43.691691, -79.440754 43.691674, -79.440771 43.691712, -79.440556 43.691761, -7|LINESTRING(-79.4404971 43.6916249,-79.440453 43.691523,-79.44084 43.691435,-79.440884 43.691537,-79.440712 43.691576,-79.440748 43.691659,-79.440673 43.691676,-79.440679 43.691691,-79.4407542 43.6916739,-79.4407708 43.6917121,-79.440556 43.691761,-79.4404|LINESTRING (-79.4404971 43.6916249, -79.440453 43.691523, -79.44084 43.691435, -79.440884 43.691537, -79.440712 43.691576, -79.440748 43.691659, -79.440673 43.691676, -79.440679 43.691691, -79.4407542 43.6916739, -79.4407708 43.6917121, -79.440556 43.6917|                |                |                 |{2,3,4,5,6,7,8,9,10,11}                                                         |{1}                      |              |              |               |
       4|{  "grptag":"", "flag":"0","npoints": "5", "tpolygon": "nd", "nb_angles": 4, "angles": "{90,90.0999999999999943,126.200000000000003,53.7000000000000028,90}", "angles_r": "{0,90,143.800000000000011,53.7000000000000028,90}", "lp_tpolygon": "{o,o,ir,ir}", "l|{90,90.0999999999999943,126.200000000000003,53.7000000000000028,90}                                                                                                                                                                                            |{0,90,143.800000000000011,53.7000000000000028,90}                                                                                                                                                                                                              |LINESTRING (-79.439644 43.692483, -79.439553 43.692265, -79.439861 43.692197, -79.440173 43.692367, -79.439644 43.692483)                                                                                                                                      |LINESTRING(-79.439644 43.692483,-79.439553 43.692265,-79.439861 43.692197,-79.440173 43.692367,-79.439644 43.692483)                                                                                                                                           |LINESTRING (-79.439644 43.692483, -79.439553 43.692265, -79.439861 43.692197, -79.440173 43.692367, -79.439644 43.692483)                                                                                                                                      |                |                |                 |{1,2,3,4}                                                                       |{}                       |              |              |               |
       5|{  "grptag":"", "flag":"0","npoints": "35", "tpolygon": "nd", "nb_angles": 32, "angles": "{179.900000000000006,89.9000000000000057,89.9000000000000057,91,88,92.4000000000000057,89.7000000000000028,94.2999999999999972,93.7999999999999972,89.099999999999994|{179.900000000000006,89.9000000000000057,89.9000000000000057,91,88,92.4000000000000057,89.7000000000000028,94.2999999999999972,93.7999999999999972,89.0999999999999943,90.5999999999999943,88.4000000000000057,89.5,89.7999999999999972,89.7000000000000028,89.|{179.900000000000006,0.100000000000000006,90,179.599999999999994,87.5,91.5999999999999943,89.7000000000000028,88.7000000000000028,88.2999999999999972,89.2000000000000028,90.5999999999999943,88.4000000000000057,89.5,89.7999999999999972,89.7000000000000028,|LINESTRING (-79.440614 43.691906, -79.440597 43.691866, -79.440777 43.691826, -79.44079 43.691857, -79.440709 43.691876, -79.440713 43.691884, -79.441001 43.691818, -79.441057 43.691949, -79.44105 43.691951, -79.441061 43.691976, -79.440988 43.691992, -79|LINESTRING(-79.4406139 43.691906,-79.440597 43.691866,-79.440777 43.691826,-79.4407902 43.6918577,-79.4407088 43.6918753,-79.440713 43.691884,-79.441001 43.691818,-79.4410571 43.6919493,-79.4410499 43.6919507,-79.441061 43.691976,-79.440988 43.691992,-79.|LINESTRING (-79.4406139 43.691906, -79.440597 43.691866, -79.440777 43.691826, -79.4407902 43.6918577, -79.4407088 43.6918753, -79.440713 43.691884, -79.441001 43.691818, -79.4410571 43.6919493, -79.4410499 43.6919507, -79.441061 43.691976, -79.440988 43.|                |                |                 |{2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,20,22,23,24,25,26,27,28,29,31,32,33,34}|{1,17,19,21,30}          |              |              |               |
       6|{  "grptag":"", "flag":"0","npoints": "20", "tpolygon": "nd", "nb_angles": 15, "angles": "{90.5,89.9000000000000057,91.2999999999999972,88.2999999999999972,125.5,178.400000000000006,177.5,53.8999999999999986,90.5,90.2000000000000028,93.0999999999999943,92|{90.5,89.9000000000000057,91.2999999999999972,88.2999999999999972,125.5,178.400000000000006,177.5,53.8999999999999986,90.5,90.2000000000000028,93.0999999999999943,92.4000000000000057,90.2999999999999972,179.5,89.5999999999999943,179.199999999999989,90.200|{0.800000000000000044,89.9000000000000057,0.599999999999999978,89.2999999999999972,125.5,178.400000000000006,177.5,53.8999999999999986,90.7000000000000028,90.4000000000000057,91.2000000000000028,90.4000000000000057,90.2999999999999972,179.5,89.59999999999|LINESTRING (-79.440155 43.692517, -79.4401261 43.6924491, -79.439781 43.692527, -79.43975 43.69246, -79.440173 43.692367, -79.440264 43.692418, -79.440355 43.692472, -79.440508 43.692555, -79.440329 43.692595, -79.440336 43.692612, -79.440286 43.692623, -|LINESTRING(-79.440155 43.6925176,-79.4401262 43.692449,-79.4397803 43.6925273,-79.4397507 43.6924597,-79.440173 43.692367,-79.440264 43.6924181,-79.4403562 43.6924698,-79.440508 43.692555,-79.440329 43.692595,-79.440336 43.692612,-79.4402858 43.6926231,-7|LINESTRING (-79.440155 43.6925176, -79.4401262 43.692449, -79.4397803 43.6925273, -79.4397507 43.6924597, -79.440173 43.692367, -79.440264 43.6924181, -79.4403562 43.6924698, -79.440508 43.692555, -79.440329 43.692595, -79.440336 43.692612, -79.4402858 43|                |                |                 |{1,2,3,4,5,8,9,10,11,12,13,15,17,18}                                            |{6,7,14,16,19}           |              |              |               |
       7|{  "grptag":"", "flag":"0","npoints": "32", "tpolygon": "nd", "nb_angles": 22, "angles": "{89.7999999999999972,179.800000000000011,142.900000000000006,179.199999999999989,178.900000000000006,179.300000000000011,179.400000000000006,179,85.7000000000000028,|{89.7999999999999972,179.800000000000011,142.900000000000006,179.199999999999989,178.900000000000006,179.300000000000011,179.400000000000006,179,85.7000000000000028,93.7999999999999972,93.2999999999999972,93.7000000000000028,90.7999999999999972,89.2000000|{0.200000000000000011,90.2000000000000028,0.100000000000000006,38,178.900000000000006,179.300000000000011,179.400000000000006,179,85.7000000000000028,91.2000000000000028,93.2999999999999972,91.7000000000000028,91.4000000000000057,90.0999999999999943,90.20|LINESTRING (-79.441045 43.692606, -79.440999 43.692586, -79.440942 43.692561, -79.440914 43.69251, -79.440894 43.692472, -79.44087 43.692429, -79.440849 43.69239, -79.440826 43.692346, -79.440799 43.692297, -79.441013 43.692248, -79.441034 43.692287, -79.|LINESTRING(-79.441045 43.692606,-79.440999 43.6925859,-79.440942 43.692561,-79.4409143 43.6925098,-79.4408938 43.6924721,-79.4408704 43.6924288,-79.4408493 43.6923898,-79.4408256 43.6923462,-79.440799 43.692297,-79.4410142 43.6922474,-79.4410328 43.692287|LINESTRING (-79.441045 43.692606, -79.440999 43.6925859, -79.440942 43.692561, -79.4409143 43.6925098, -79.4408938 43.6924721, -79.4408704 43.6924288, -79.4408493 43.6923898, -79.4408256 43.6923462, -79.440799 43.692297, -79.4410142 43.6922474, -79.441032|                |                |                 |{1,3,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,25,26,27,29}                   |{2,4,5,6,7,8,24,28,30,31}|              |              |               |
       8|{  "grptag":"", "flag":"0","npoints": "12", "tpolygon": "nd", "nb_angles": 10, "angles": "{91.2000000000000028,89.7000000000000028,88.2999999999999972,90,179.199999999999989,91.0999999999999943,89.2999999999999972,89.5,90.7999999999999972,124.099999999999|{91.2000000000000028,89.7000000000000028,88.2999999999999972,90,179.199999999999989,91.0999999999999943,89.2999999999999972,89.5,90.7999999999999972,124.099999999999994,55.5,91.2000000000000028}                                                             |{0,90.2000000000000028,0.5,90.5999999999999943,179.800000000000011,91.7999999999999972,88.5999999999999943,89.5,90.7999999999999972,124.099999999999994,55.5,91.2000000000000028}                                                                              |LINESTRING (-79.440426 43.692694, -79.440421 43.692683, -79.440384 43.692692, -79.440369 43.692656, -79.44041 43.692647, -79.440514 43.692623, -79.440505 43.692601, -79.440372 43.692631, -79.440355 43.69259, -79.440508 43.692555, -79.440659 43.692642, -79|LINESTRING(-79.4404259 43.692694,-79.4404211 43.692683,-79.440384 43.692692,-79.440369 43.692656,-79.4404099 43.6926467,-79.4405138 43.6926231,-79.4405052 43.6926009,-79.440372 43.692631,-79.440355 43.69259,-79.440508 43.692555,-79.440659 43.692642,-79.44|LINESTRING (-79.4404259 43.692694, -79.4404211 43.692683, -79.440384 43.692692, -79.440369 43.692656, -79.4404099 43.6926467, -79.4405138 43.6926231, -79.4405052 43.6926009, -79.440372 43.692631, -79.440355 43.69259, -79.440508 43.692555, -79.440659 43.69|                |                |                 |{1,2,3,4,6,7,8,9,10,11}                                                         |{5}                      |              |              |               |
      10|{  "grptag":"", "flag":"0","npoints": "11", "tpolygon": "r", "nb_angles": 8, "angles": "{89.2999999999999972,91.4000000000000057,89.0999999999999943,89.0999999999999943,91.7999999999999972,89.7000000000000028,90.5999999999999943,179.699999999999989,179.5,|{89.2999999999999972,91.4000000000000057,89.0999999999999943,89.0999999999999943,91.7999999999999972,89.7000000000000028,90.5999999999999943,179.699999999999989,179.5,90.5999999999999943,89.2999999999999972}                                                |{90.9000000000000057,91.4000000000000057,89.0999999999999943,89.0999999999999943,93.0999999999999943,91.4000000000000057,89.7999999999999972,179.800000000000011,179.5,88.9000000000000057,89.2999999999999972}                                                |LINESTRING (-79.444218 43.693736, -79.444175 43.693631, -79.444192 43.693627, -79.444184 43.69361, -79.444201 43.693606, -79.444199 43.693601, -79.444228 43.693595, -79.444237 43.693617, -79.444251 43.693652, -79.44428 43.693722, -79.444218 43.693736)    |LINESTRING(-79.4442179 43.6937354,-79.444175 43.693631,-79.444192 43.693627,-79.444184 43.69361,-79.4442009 43.693606,-79.4441991 43.693601,-79.4442287 43.6935947,-79.4442375 43.6936168,-79.4442513 43.6936519,-79.4442794 43.6937229,-79.4442179 43.6937354)|LINESTRING (-79.4442179 43.6937354, -79.444175 43.693631, -79.444192 43.693627, -79.444184 43.69361, -79.4442009 43.693606, -79.4441991 43.693601, -79.4442287 43.6935947, -79.4442375 43.6936168, -79.4442513 43.6936519, -79.4442794 43.6937229, -79.4442179 |                |                |                 |{1,2,3,4,5,6,7,10}                                                              |{8,9}                    |              |              |               |
      11|{  "grptag":"", "flag":"0","npoints": "7", "tpolygon": "nd", "nb_angles": 4, "angles": "{90.5999999999999943,178.800000000000011,91.7000000000000028,88.5999999999999943,179.400000000000006,89.5999999999999943,90.5999999999999943}", "angles_r": "{90.299999|{90.5999999999999943,178.800000000000011,91.7000000000000028,88.5999999999999943,179.400000000000006,89.5999999999999943,90.5999999999999943}                                                                                                                  |{90.2999999999999972,179,91.5999999999999943,89.2000000000000028,179.900000000000006,89.7000000000000028,90.5999999999999943}                                                                                                                                  |LINESTRING (-79.444294 43.693754, -79.444251 43.693652, -79.444242 43.693629, -79.444303 43.693615, -79.444311 43.693635, -79.444355 43.693741, -79.444294 43.693754)                                                                                          |LINESTRING(-79.4442935 43.6937542,-79.4442518 43.6936517,-79.4442425 43.6936288,-79.444303 43.693615,-79.4443112 43.6936349,-79.444355 43.693741,-79.4442935 43.6937542)                                                                                       |LINESTRING (-79.4442935 43.6937542, -79.4442518 43.6936517, -79.4442425 43.6936288, -79.444303 43.693615, -79.4443112 43.6936349, -79.444355 43.693741, -79.4442935 43.6937542)                                                                                |                |                |                 |{1,3,4,6}                                                                       |{2,5}                    |              |              |               |
drop table IF EXISTS temp_fjson;
create temporary table temp_fjson as 
SELECT public.OQ_PostGIS2Json('oq_sample','oq_s1b_building_extring_orthogonal','linestring_r') as tjson;
copy (select tjson from temp_fjson) TO 'd:/temp/oq_s1b_building_extring_orthogonal.geojson' encoding 'utf-8'; 

